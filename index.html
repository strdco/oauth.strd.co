<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
<!---
    <link rel="shortcut icon" href="/logo.png" type="image/png">
    <link rel="icon" href="/logo.png" type="image/png">

    <link rel="stylesheet" href="/style.css"/>

    <script src="/client-side.js"></script>
--->

    <title>OAuth Wizard</title>
</head>
<body>

<style>
    html {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
    }

    body {
        background-image: url('./codioful-formerly-gradienta-J6LMHbdW1k8-unsplash.jpg');
        background-size: cover;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
    }

    a.credit {
        display: none;
    }

    .panel {
        margin: 20px auto;
        width: 50%;
        min-width: 400px;
        max-width: 600px;
        height: calc(100% - 130px);
        padding: 40px;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(20px);
        box-shadow: 0 10px 200px rgba(0, 0, 0, 0.25);
        border-width: 1px;
        border-style: solid;
        border-color: rgba(255, 255, 255, 0.75);
        border-radius: 10px;
        overflow-y: auto;
    }

    .step {
        background-color: white;
        margin: 20px auto;
        padding: 30px;
        font-size: 20px;
        border-radius: 10px;
        border-left-style: solid;
        border-left-width: 4px;
        border-left-color: white;
    }

    .step.json-response {
        display: none;
        background-color: rgb(0, 0, 0, 0.75);
        color: rgb(224, 224, 224);
        font-size: 12px;
        font-family: 'Lucida Console', 'Courier New', Courier, monospace;
        border-left-style: none;
        overflow-x: hidden;
    }

    .step.json-response::before {
        position: absolute;
        transform: translateY(-34px);
        padding: 6px 20px;
        border-radius: 4px;
        z-index: 100;
        color: white;
        content: attr(data-http-status);
    }
    
    .step.json-response[data-http-status^="HTTP/2"]::before {
        background-color: rgb(0, 128, 0);
        color: white;
    }

    .step.json-response[data-http-status^="HTTP/3"]::before {
        background-color: rgb(255, 160, 0);
        color: black;
    }

    .step.json-response[data-http-status^="HTTP/4"]::before {
        background-color: rgb(160, 0, 0);
        color: white;
    }

    .step.json-response[data-http-status^="HTTP/5"]::before {
        background-color: rgb(255, 0, 0);
        color: black;
    }

    .step:focus-within {
        border-left-color: rgba(255, 64, 128);
    }

    .step div {
        margin-top: 5px;
    }
    .step span {
        display: inline-block;
        padding-top: 10px;
    }

    .step.refresh,
    input[type="button"]#fetchrefreshtoken {
        display: none;
    }

    label {
        width: 120px;
        margin-right: 5%;
        display: inline-block;
    }

    input, select {
        width: calc(100% - 170px);
        font-size: 20px;
        padding: 5px;
        border-radius: 3px;
        border-style: solid;
        border-width: 1px;
        border-color: rgb(64, 64, 64);
    }

    input[type="button"] {
        background-color: rgba(255, 64, 128);
        border-width: 1px;
        border-radius: 10px;
        color: white;
        display: block;
        margin: auto;
        cursor: pointer;
    }

    input[type="button"]:active {
        padding: 7px 3px 3px 7px;
        box-shadow: inset 10px 10px 10px -10px rgba(0,0,0,0.5);
    }

    input.wide {
        width: calc(100% - 25px);
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="url"]:focus {
        background-color: rgba(255, 220, 0, 0.3);
    }

    input#authcode:valid {
        background-color: rgba(0, 220, 0, 0.3);
    }

    .has-refresh-icon::after {
        content: "\21bb";
        display: block;
        position: absolute;
        right: 80px;
        transform: translateY(-32px); /* Adjust for vertical centering */
        width: 28px; /* Adjust size as needed */
        height: 28px;
        background-color: transparent; /* Make background transparent */
        z-index: 100;
        overflow: hidden;
        padding-left: 8px;
        border-radius: 8px;
        font-size: 24px;
        background-color: rgb(0, 128, 0);
        color: white; /* Icon color */
        opacity: 0.25;
        cursor: pointer;
    }

    .has-refresh-icon:hover::after {
        opacity: 1.0;
    }

</style>


<!----
https://www.oauth.com/oauth2-servers/authorization/the-authorization-request/
https://www.oauth.com/oauth2-servers/authorization/the-authorization-response/
https://www.oauth.com/oauth2-servers/access-tokens/authorization-code-request/

--->

<script defer>

    /*
     *
     * STEP 1: Fetch the auth code by having the user log in:
     * 
     */

    function fetchAuthCode() {
        // Clear old auth code and access/refresh tokens
        document.querySelector('#authcode').value='';
        document.querySelector('#accesstoken').value='';
        document.querySelector('#refreshtoken').value='';

        // ... and save all our inputs to local storage:
        saveFields();

        // Construct the OAuth 2.0 URL to authenticate:
        var url=document.querySelector('#url_1').value;
        url = url+(url.indexOf('?')>=0 ? '&' : '?') +
            'response_type=code' +
            '&client_id=' + encodeURIComponent(document.querySelector('#clientid_1').value) +
            '&redirect_uri=' + encodeURIComponent(document.location.origin) +
            '&scope=' + encodeURIComponent(document.querySelector('#scope').value) +
            '&state=' + encodeURIComponent(document.querySelector('#state').value) +
            '&access_type=offline'+ // TODO: add checkbox for this option (required for refresh tokens); otherwise, access_type=online
            '&prompt=consent' // TODO: add checkbox for this option (required for refresh tokens)

        console.log(url.split('&'));
        // .. and open it:
        window.open(url, '_self');
    }

    /*
     *
     * STEP 2: The auth code that comes back from the auth server:
     * 
     */

    function receiveAuthCode(queryStringParams) {
        if (queryStringParams.get('state')!=localStorage.getItem('state')) {
            window.alert('Returned state\n'+queryStringParams.get('state')+
                '\n... is not the one we expected:\n'+
                localStorage.getItem('state'));
        } else {
            document.querySelector('#authcode').value=queryStringParams.get('code');

            if (queryStringParams.get('scope')) {
                document.querySelector('#scope').value=queryStringParams.get('scope');
            }
        }
    }

    /*
     *
     * STEP 3: Fetch the access token:
     * 
     */

    function fetchAccessToken() {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', document.querySelector('#url_2').value);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        document.querySelector('#accesstoken').value='';
        document.querySelector('#refreshtoken').value='';

        xhr.onload = function() {
            const blob=JSON.parse(xhr.response);
            var element=document.querySelector('#fetchtoken + .json-response');
            element.setAttribute('data-http-status', 'HTTP/'+xhr.status);
            element.innerText=JSON.stringify(blob, null, 3);
            element.style.display='block';

            if (xhr.status==200) {
                document.querySelector('#accesstoken').value=blob.access_token;
                if (blob.refresh_token) {
                    document.querySelector('.step.refresh').style.display='block';
                    document.querySelector('input[type="button"]#fetchrefreshtoken').style.display='block';
                    document.querySelector('#refreshtoken').value=blob.refresh_token;
                } else {
                    document.querySelector('.step.refresh').style.display='none';
                    document.querySelector('input[type="button"]#fetchrefreshtoken').style.display='none';
                }
            }
        }

        xhr.send(
            'client_id='+encodeURIComponent(document.querySelector('#clientid_2').value)+
            '&client_secret='+encodeURIComponent(document.querySelector('#clientsecret_2').value)+
            '&code='+encodeURIComponent(document.querySelector('#authcode').value)+
            '&grant_type=authorization_code'+
            '&redirect_uri='+encodeURIComponent(document.location.origin)
        );
    }

    /*
     *
     * STEP 4: Refresh the access token:
     * 
     */

    function refreshAccessToken() {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', document.querySelector('#url_3').value);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        document.querySelector('#accesstoken').value='';
        document.querySelector('#refreshtoken').value='';

        xhr.onload = function() {
            const blob=JSON.parse(xhr.response);
            var element=document.querySelector('#refreshtoken + .json-response');
            element.setAttribute('data-http-status', 'HTTP/'+xhr.status);
            element.innerText=JSON.stringify(blob, null, 3);
            element.style.display='block';

            if (xhr.status==200) {
                document.querySelector('#accesstoken').value=blob.access_token;
                if (blob.refresh_token) {
                    document.querySelector('.step.refresh').style.display='block';
                    document.querySelector('input[type="button"]#fetchrefreshtoken').style.display='block';
                    document.querySelector('#refreshtoken').value=blob.refresh_token;
                } else {
                    document.querySelector('.step.refresh').style.display='none';
                    document.querySelector('input[type="button"]#fetchrefreshtoken').style.display='none';
                }
            }
        }

        xhr.send(
            'client_id='+encodeURIComponent(document.querySelector('#clientid_3').value)+
            '&client_secret='+encodeURIComponent(document.querySelector('#clientsecret_3').value)+
            '&refresh_token='+encodeURIComponent(document.querySelector('#refreshtoken').value)+
            '&grant_type=refresh_token');
    }









    /*
     *
     * When the page loads
     * 
     */

    window.onload = function letsgo() {
        const urlParams = new URLSearchParams(window.location.search);

        document.querySelector('#urlselector').addEventListener('change', (e) => {
            document.querySelector('#url_1').value=e.target.value.split(';')[0];
            document.querySelector('#url_2').value=e.target.value.split(';')[1];
            document.querySelector('#url_3').value=e.target.value.split(';')[1];
            document.querySelector('#scope').value=e.target.value.split(';')[2];
        });

        applyCopyEvent('clientid');
        applyCopyEvent('clientsecret');

        if (!localStorage.getItem('state')) {
            localStorage.setItem('state', generateState());
        }

        document.querySelector('#granttype').value=localStorage.getItem('granttype');

        document.querySelector('#url_1').value=localStorage.getItem('authurl');
        document.querySelector('#clientid_1').value=localStorage.getItem('clientid');
        document.querySelector('#clientid_2').value=localStorage.getItem('clientid');
        document.querySelector('#clientid_3').value=localStorage.getItem('clientid');
        document.querySelector('#state').value=localStorage.getItem('state');
        document.querySelector('#scope').value=localStorage.getItem('scope');

        document.querySelector('#url_2').value=localStorage.getItem('tokenurl');
        document.querySelector('#url_3').value=localStorage.getItem('tokenurl');



        document.querySelector('.has-refresh-icon').addEventListener('click', () => {
            localStorage.setItem('state', generateState());
            document.querySelector('#state').value=localStorage.getItem('state');
        });

        document.querySelector('#fetchauth').addEventListener('click', (e) => {
            fetchAuthCode();
        });

        document.querySelector('#fetchtoken').addEventListener('click', (e) => {
            switch (document.querySelector('#granttype').value) {
                case 'auth_code':
                    fetchAccessToken();
                    exit;
            }
        });

        document.querySelector('#fetchrefreshtoken').addEventListener('click', (e) => {
            switch (document.querySelector('#granttype').value) {
                case 'auth_code':
                    refreshAccessToken();
                    exit;
            }
        });




        // If this is the return URI for fetching an auth code:
        if (urlParams.get('code') && urlParams.get('state')) {
            receiveAuthCode(urlParams);
        }

    };









    /*
     *
     * Helper stuff
     * 
     */

     function copyInputValues(sourceElement) {
        document.querySelectorAll('input[name="'+sourceElement.target.name+'"]').forEach(input => {
            if (input.id!=sourceElement.target.id) { input.value=sourceElement.target.value; }
        });
    }

    function applyCopyEvent(name) {
        document.querySelectorAll('input[name="'+name+'"]').forEach(input => {
            input.addEventListener('change', (e) => { copyInputValues(e); });
        });
    }

    function generateState() {
        const bytes = new Uint8Array(12);
        window.crypto.getRandomValues(bytes);
        return Array.from(bytes, byte => byte.toString(16).padStart(2, '0')).join('');
    }

    // Saves the values in the input fields in local storage:
    function saveFields() {
        localStorage.setItem('granttype', document.querySelector('#granttype').value);

        localStorage.setItem('authurl', document.querySelector('#url_1').value);
        localStorage.setItem('clientid', document.querySelector('#clientid_1').value || document.querySelector('#clientid_2').value || document.querySelector('#clientid_3').value);
        localStorage.setItem('state', document.querySelector('#state').value);
        localStorage.setItem('scope', document.querySelector('#scope').value);

        localStorage.setItem('tokenurl', document.querySelector('#url_2').value || document.querySelector('#url_3').value);
        localStorage.setItem('clientsecret', document.querySelector('#clientsecret_2').value || document.querySelector('#clientsecret_3').value);

        localStorage.setItem('accesstoken', document.querySelector('#accesstoken').value);
        localStorage.setItem('refreshtoken', document.querySelector('#refreshtoken').value);
    }

    function populateFields() {

    }

</script>




<div class="panel">
    <div class="step">
        <div>
            <label for="granttype">Grant type:</label>
            <select id="granttype">
            <!--<option value="client_credentials">Client credentials</option> --->
                <option value="auth_code">Auth code</option>
            </select>
        </div>
    </div>

    <form>
        <div class="step">
            <div>
                <label for="urlselector">Service URL:</label>
                <select class="wide" id="urlselector">
                    <option value=";;""></option>
                    <option value="https://accounts.google.com/o/oauth2/v2/auth;https://oauth2.googleapis.com/token;profile">Google</option>
                    <option value="https://apps.fortnox.se/oauth-v1/auth;https://apps.fortnox.se/oauth-v1/token;">Fortnox</option>
                </select>
            </div>
            <div>
                <input type="url" class="wide" id="url_1" name="url" placeholder="https://example.com/oauth/auth"/>
            </div>
            <div>
                <label for="clientid_1">Client Id:</label>
                <input class= type="text" id="clientid_1" name="clientid" placeholder="Client Id"/>
            </div>
            <div class="has-refresh-icon">
                <label for="State">State:</label>
                <input type="text" id="state" name="state" placeholder="State"/>
            </div>
            <div>
                <label for="scope">Scope:</label>
                <input type="text" id="scope" name="scope" placeholder="Scope"/>
            </div>
        </div>

        <input id="fetchauth" type="button" value="Fetch auth code"/>

        <pre class="step json-response"></pre>
    </form>

    <form>
        <div class="step">
            <div>
                <input type="url" class="wide" id="url_2" name="url" placeholder="https://example.com/oauth/token"/>
            </div>
            <div>
                <label for="authcode">Auth code:</label>
                <input type="text" id="authcode" name="authcode" required placeholder=""/>
            </div>
            <div>
                <label for="clientid_2">Client Id:</label>
                <input type="text" id="clientid_2" name="clientid" placeholder=""/>
            </div>
            <div>
                <label for="clientsecret_2">Client Secret:</label>
                <input type="password" id="clientsecret_2" name="clientsecret" placeholder=""/>
            </div>
        </div>

        <input id="fetchtoken" type="button" value="Fetch token"/>

        <pre class="step json-response"></pre>
    </form>

    <div class="step">
        <div>
            <span>Access token:</span>
            <input class="wide" type="text" id="accesstoken" name="accesstoken"/>
        </div>
    </div>

    <form>
        <div class="step refresh">
            <div>
                <input type="url" class="wide" id="url_3" name="url" placeholder="https://example.com/oauth/token"/>
            </div>
            <div>
                <label for="clientid_3">Client Id:</label>
                <input type="text" id="clientid_3" name="clientid" placeholder=""/>
            </div>
            <div>
                <label for="clientsecret_3">Client Secret:</label>
                <input type="password" id="clientsecret_3" name="clientsecret" placeholder=""/>
            </div>
            <div>
                <span>Refresh token:</span>
                <input class="wide" type="text" id="refreshtoken" name="refreshtoken"/>
            </div>
        </div>

        <input id="fetchrefreshtoken" type="button" value="Refresh tokens"/>

        <pre class="step json-response"></pre>

    </form>
</div>


<!----
<a class="credit" href="https://unsplash.com/photos/blue-and-white-abstract-painting-J6LMHbdW1k8"></a>
--->

</body>
</html>
